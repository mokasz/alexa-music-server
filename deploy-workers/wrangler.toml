# Cloudflare Workers configuration for Alexa Music Server
name = "alexa-music-workers"
main = "src/index.js"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Account settings (will be set after login)
# account_id = "your-account-id"

# KV Namespaces
[[kv_namespaces]]
binding = "MUSIC_DB"
id = "29af5a6de5be45c188828a14d84cad6d"

[[kv_namespaces]]
binding = "SESSIONS"
id = "4725a7e7a1ec44219db4f4a0fe7679b5"

[[kv_namespaces]]
binding = "CERT_CACHE"
id = "1b8cac75de4f4033af494f4ca71af817"

# Environment Variables
[vars]
NODE_ENV = "production"
PUBLIC_URL = "https://alexa-music-workers.swiftzhu.workers.dev"
ALEXA_VERIFY_SIGNATURE = "true"  # HIGH-001: Rate limiting now uses in-memory cache (no KV writes)

# Secrets (CRITICAL-001: Must be set via wrangler secret, NOT environment variables)
# Generate secure secret: openssl rand -base64 32
# Set secrets:
#   wrangler secret put JWT_SECRET       # Must be at least 32 characters
#   wrangler secret put ALEXA_SKILL_ID   # amzn1.ask.skill.xxxxx
# Rotate JWT_SECRET every 90 days for security

# Build configuration
[build]
command = ""

# Development settings
[dev]
port = 8787
local_protocol = "http"

# Routes (optional - for custom domains)
# routes = [
#   { pattern = "alexa-music-workers.moerin.com/*", custom_domain = true }
# ]

# Usage model (paid plan required for higher limits)
# usage_model = "bundled"  # or "unbound"

# Limits (free tier)
# - 100,000 requests/day
# - 10ms CPU time per request
# - 1GB KV reads/day
# - 1,000 KV writes/day

# Durable Objects
[[durable_objects.bindings]]
name = "SESSIONS_DO"
class_name = "SessionDurableObject"
script_name = "alexa-music-workers"

# Migrations for Durable Objects (required for deployment)
# Use new_sqlite_classes for free plan
[[migrations]]
tag = "v1"
new_sqlite_classes = ["SessionDurableObject"]
